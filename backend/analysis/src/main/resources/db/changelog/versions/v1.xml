<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="
          http://www.liquibase.org/xml/ns/dbchangelog
          http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.27.xsd">

    <changeSet id="001-create-history-table" author="sergii.kryvko">

        <createTable tableName="history">

            <column name="request_id" type="uuid" defaultValueComputed="gen_random_uuid()">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="processing_status" type="varchar(20)">
                <constraints nullable="false"/>
            </column>

            <column name="source_type" type="varchar(20)">
                <constraints nullable="false"/>
            </column>

            <column name="user_id" type="uuid">
                <constraints nullable="false"/>
            </column>

            <column name="created_at" type="timestamptz" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>

            <column name="updated_at" type="timestamptz"/>

            <column name="recommendation" type="varchar(255)"/>

        </createTable>

    </changeSet>

    <changeSet id="002-user-table" author="sergii.kryvko">
        <createTable tableName="users">

            <column name="user_id" type="uuid" defaultValueComputed="gen_random_uuid()">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="email" type="varchar(100)">
                <constraints nullable="false" unique="true"/>
            </column>

            <column name="gender" type="varchar(20)">
                <constraints nullable="true"/>
            </column>

            <column name="password_hash" type="varchar">
                <constraints nullable="false"/>
            </column>

            <column name="registered_at" type="timestamptz" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="003-history-details-table" author="sergii.kryvko">

        <createTable tableName="history_processing_item">
            <column name="item_id" type="uuid" defaultValueComputed="gen_random_uuid()">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="request_id" type="uuid">
                <constraints nullable="false"/>
            </column>

            <column name="file_location" type="varchar"/>

            <column name="processing_status" type="varchar(20)">
                <constraints nullable="false"/>
            </column>

            <column name="created_at" type="timestamptz" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>

        </createTable>

        <createTable tableName="history_item_result">
            <column name="result_id" type="uuid" defaultValueComputed="gen_random_uuid()">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="item_id" type="uuid">
                <constraints nullable="false"/>
            </column>

            <column name="request_id" type="uuid">
                <constraints nullable="false"/>
            </column>

            <column name="model_name" type="varchar(100)">
                <constraints nullable="false"/>
            </column>

            <column name="diagnose" type="varchar(100)">
                <constraints nullable="false"/>
            </column>

            <column name="probability" type="decimal">
                <constraints nullable="false"/>
            </column>

        </createTable>

        <addForeignKeyConstraint baseTableName="history_processing_item"
                                 baseColumnNames="request_id"
                                 constraintName="fk_history_processing_item_request"
                                 referencedTableName="history"
                                 referencedColumnNames="request_id"
                                 onDelete="CASCADE"/>

        <addForeignKeyConstraint baseTableName="history_item_result"
                                 baseColumnNames="item_id"
                                 constraintName="fk_history_item_result_item"
                                 referencedTableName="history_processing_item"
                                 referencedColumnNames="item_id"
                                 onDelete="CASCADE"/>

    </changeSet>

    <changeSet id="004-models-metadata" author="sergii.kryvko">
        <createTable tableName="evaluation_model_metadata">
            <column name="model_id" type="uuid" defaultValueComputed="gen_random_uuid()">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="model_name" type="varchar(100)">
                <constraints nullable="false" unique="true"/>
            </column>

            <column name="diagnose" type="varchar(100)">
                <constraints nullable="false"/>
            </column>

            <column name="model_auc" type="decimal">
                <constraints nullable="false"/>
            </column>

            <column name="description" type="varchar(255)"/>
        </createTable>

        <sql>
            INSERT INTO evaluation_model_metadata (model_name, diagnose, model_auc, description)
            VALUES ('COVID_COUGH_OperaCT_768', 'COVID19', 0.57, 'Defines probability of COVID-19'),
                   ('COVIDUK_COUGH_OperaCT_768', 'COVID19', 0.70, 'Defines probability of COVID-19'),
                   ('ICBHI_DISEASE_OperaCT_768', 'COPD', 0.85,
                    'Defines probability of Chronic Obstructive Pulmonary Disease')
        </sql>
    </changeSet>
</databaseChangeLog>